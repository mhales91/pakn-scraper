name: scrape

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *" # daily at 01:00 UTC

jobs:
  scrape:
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 6 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Restore packages
        working-directory: src
        run: dotnet restore

      - name: Build (Debug)
        working-directory: src
        run: dotnet build -c Debug

      - name: Install Playwright Chromium
        working-directory: src
        shell: pwsh
        run: bin/Debug/net6.0/playwright.ps1 install chromium

      - name: Verify Urls.txt exists
        working-directory: src
        run: |
          set -e
          test -f Urls.txt && echo "Found src/Urls.txt" || (echo "src/Urls.txt missing!" && exit 1)
          head -n 3 Urls.txt || true

      # Create appsettings.json as ONE line and copy both files into the runtime folder
      - name: Stage runtime inputs (Urls.txt + appsettings.json) to bin/Debug/net6.0
        working-directory: src
        run: |
          RUNTIME_DIR="bin/Debug/net6.0"
          mkdir -p "$RUNTIME_DIR"

          # Write single-line JSON (no BOM, no trailing comma/newline)
          printf '{"GEOLOCATION_LAT":"-37.73953","GEOLOCATION_LONG":"176.09528"}' > appsettings.json

          # Show what we wrote
          echo "appsettings.json content:"
          cat appsettings.json

          # Copy inputs into runtime dir (where the app reads from)
          cp Urls.txt "$RUNTIME_DIR/Urls.txt"
          cp appsettings.json "$RUNTIME_DIR/appsettings.json"

          # List for sanity
          echo "Runtime dir contents:"
          ls -la "$RUNTIME_DIR"

      - name: Run scraper (Debug, no rebuild)
        working-directory: src
        run: |
          set -o pipefail
          { dotnet run -c Debug --no-build; } \
            >  ../out.stdout.txt \
            2> ../out.stderr.txt
          echo "Exit code: $?"

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: scrape-outputs
          path: |
            out.stdout.txt
            out.stderr.txt
            src/Urls.txt
            src/appsettings.json
            src/bin/Debug/net6.0/appsettings.json
            src/bin/Debug/net6.0/Urls.txt
          if-no-files-found: warn
